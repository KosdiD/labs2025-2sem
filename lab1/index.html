<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="controls">
        Use WASD to move | Mouse to look | Space to jump | Click objects to push
    </div>

    <a-scene
        physics="gravity: -9.8; debug: false"
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false">

        <!-- Assets -->
        <a-assets>
            <img id="hardwood" src="../textures/hardwood.jpg">
            <img id="disturb" src="../textures/disturb.jpg">
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" intensity="0.5"></a-light>
        <a-light type="directional" position="3 10 5" intensity="0.8" castShadow="true"></a-light>

        <!-- Ground -->
        <a-plane 
            static-body
            position="0 0 -4" 
            rotation="-90 0 0" 
            width="50" 
            height="50" 
            material="src: #disturb; repeat: 10 10"
            shadow="receive: true">
        </a-plane>

        <!-- Ramp -->
        <a-box 
            static-body
            position="5 1.5 -10" 
            rotation="-20 0 0"
            width="4" 
            height="0.2" 
            depth="8"
            material="src: #hardwood; repeat: 2 4"
            shadow>
        </a-box>

        <!-- Physics Objects -->
        <!-- Rolling Cylinders -->
        <a-cylinder 
            dynamic-body="shape: cylinder"
            position="4 5 -12"
            rotation="0 0 90"
            radius="0.5" 
            height="1"
            material="src: #hardwood; repeat: 2 1"
            shadow>
        </a-cylinder>

        <a-cylinder 
            dynamic-body="shape: cylinder"
            position="5.5 6 -11"
            rotation="0 0 90"
            radius="0.3" 
            height="0.8"
            material="color: #FF6B6B"
            shadow>
        </a-cylinder>

        <!-- Boxes -->
        <a-box 
            dynamic-body
            position="-3 0.5 -5"
            width="1"
            height="1"
            depth="1"
            material="color: #4ECDC4"
            shadow>
        </a-box>

        <a-box 
            dynamic-body
            position="-3 1.5 -5"
            width="0.8"
            height="0.8"
            depth="0.8"
            material="color: #95E1D3"
            shadow>
        </a-box>

        <!-- Spheres -->
        <a-sphere 
            dynamic-body
            position="0 0.5 -8"
            radius="0.5"
            material="color: #F38181"
            shadow>
        </a-sphere>

        <a-sphere 
            dynamic-body
            position="1 0.5 -7"
            radius="0.3"
            material="color: #AA96DA"
            shadow>
        </a-sphere>

        <!-- Walls -->
        <a-box 
            static-body
            position="10 2.5 -10"
            width="0.5"
            height="5"
            depth="20"
            material="color: #8B8B8B"
            shadow>
        </a-box>

        <a-box 
            static-body
            position="-10 2.5 -10"
            width="0.5"
            height="5"
            depth="20"
            material="color: #8B8B8B"
            shadow>
        </a-box>

        <!-- Stack of objects -->
        <a-box 
            dynamic-body
            position="3 0.5 -6"
            material="color: #FCBAD3">
        </a-box>
        <a-box 
            dynamic-body
            position="3 1.5 -6"
            material="color: #FFFFD2">
        </a-box>
        <a-box 
            dynamic-body
            position="3 2.5 -6"
            material="color: #AA96DA">
        </a-box>

        <!-- Player Camera with Physics -->
        <a-entity 
            id="player"
            movement-controls="fly: false; constrainToNavMesh: false"
            kinematic-body="radius: 0.5"
            position="0 1.6 0">
            <a-camera
                look-controls
                wasd-controls="acceleration: 20">
                <a-cursor
                    animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                    animation__fusing="property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: white; shader: flat">
                </a-cursor>
            </a-camera>
        </a-entity>

        <!-- AR camera for mobile -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Add click-to-push functionality
        AFRAME.registerComponent('click-impulse', {
            init: function () {
                this.el.addEventListener('click', () => {
                    if (this.el.body) {
                        const force = new THREE.Vector3(
                            (Math.random() - 0.5) * 10,
                            Math.random() * 10 + 5,
                            (Math.random() - 0.5) * 10
                        );
                        this.el.body.applyImpulse(
                            new CANNON.Vec3(force.x, force.y, force.z),
                            new CANNON.Vec3(0, 0, 0)
                        );
                    }
                });
            }
        });

        // Apply click-impulse to all dynamic bodies
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.querySelectorAll('[dynamic-body]').forEach(el => {
                    el.setAttribute('click-impulse', '');
                });
            }, 1000);
        });

        // Add jump functionality (spacebar)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                const player = document.querySelector('#player');
                if (player.body) {
                    player.body.velocity.y = 8;
                }
            }
        });

        // Spawn new objects periodically
        let spawnInterval = setInterval(() => {
            const scene = document.querySelector('a-scene');
            const shapes = ['box', 'sphere', 'cylinder'];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            const el = document.createElement(`a-${shape}`);
            
            el.setAttribute('dynamic-body', '');
            el.setAttribute('position', {
                x: (Math.random() - 0.5) * 8,
                y: 10,
                z: -10 + (Math.random() - 0.5) * 8
            });
            
            if (shape === 'cylinder') {
                el.setAttribute('radius', 0.3 + Math.random() * 0.3);
                el.setAttribute('height', 0.5 + Math.random() * 0.5);
                el.setAttribute('rotation', '0 0 90');
            } else if (shape === 'sphere') {
                el.setAttribute('radius', 0.3 + Math.random() * 0.3);
            } else {
                el.setAttribute('width', 0.5 + Math.random() * 0.5);
                el.setAttribute('height', 0.5 + Math.random() * 0.5);
                el.setAttribute('depth', 0.5 + Math.random() * 0.5);
            }
            
            el.setAttribute('material', {
                color: `#${Math.floor(Math.random()*16777215).toString(16)}`
            });
            el.setAttribute('shadow', '');
            el.setAttribute('click-impulse', '');
            
            scene.appendChild(el);
            
            // Remove old objects to prevent performance issues
            setTimeout(() => {
                el.parentNode.removeChild(el);
            }, 30000);
        }, 3000);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(spawnInterval);
        });
    </script>
</body>
</html>
